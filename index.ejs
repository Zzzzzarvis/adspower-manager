<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AdsPowerå¤šç¯å¢ƒç®¡ç†å™¨</title>
  <link rel="stylesheet" href="/css/styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>
<body>
  <div class="container">
    <h1>AdsPowerå¤šç¯å¢ƒç®¡ç†å™¨</h1>
    
    <!-- æ·»åŠ å¯¼èˆªèœå• -->
    <div class="nav-menu">
      <a href="/" class="nav-item active">é¦–é¡µ</a>
      <a href="#" id="nav-element-explorer" class="nav-item">å…ƒç´ æ¢ç´¢å™¨</a>
    </div>
    
    <div class="main-content">
      <!-- å·¦ä¾§ç¯å¢ƒåˆ—è¡¨ -->
      <div class="environments-panel">
        <h2>ç¯å¢ƒåˆ—è¡¨</h2>
        
        <!-- åˆ†ç»„é€‰æ‹© -->
        <div class="group-selection">
          <select id="group-select">
            <option value="">-- æ‰€æœ‰åˆ†ç»„ --</option>
            <% if (Array.isArray(groups) && groups.length > 0) { %>
              <% groups.forEach(function(group) { %>
                <option value="<%= group.group_id %>" <%= selectedGroup === group.group_id ? 'selected' : '' %>>
                  <%= group.group_name %> (<%= group.count || 0 %>)
                </option>
              <% }); %>
            <% } %>
          </select>
        </div>
        
        <div class="env-list">
          <% if (!environments || environments.length === 0) { %>
            <div class="empty-list">æ²¡æœ‰æ‰¾åˆ°ç¯å¢ƒï¼Œè¯·å°è¯•é€‰æ‹©å…¶ä»–åˆ†ç»„</div>
          <% } else { %>
            <% environments.forEach(function(env) { %>
              <div class="env-item <%= env.status === 'running' ? 'active' : '' %>" data-id="<%= env.id %>">
                <div class="env-info">
                  <span class="env-id"><%= env.id %></span>
                </div>
                <div class="env-name">
                  <%= env.name || 'ç¯å¢ƒ ' + env.id %>
                  <% if (env.notes) { %>
                    <span class="env-note-badge" title="<%= env.notes %>">ğŸ“</span>
                  <% } %>
                </div>
                <div class="env-status-container">
                  <span class="env-status <%= env.status === 'running' ? 'status-running' : 'status-stopped' %>">
                    <%= env.status === 'running' ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢' %>
                  </span>
                  <% if (activeTasks && activeTasks[env.id]) { %>
                    <span class="env-task" title="æ­£åœ¨æ‰§è¡Œä»»åŠ¡: <%= activeTasks[env.id].name %>">
                      âš™ï¸ <%= activeTasks[env.id].name %>
                    </span>
                  <% } %>
                </div>
                <div class="env-actions">
                  <% if (env.status !== 'running') { %>
                    <button class="btn-start" data-id="<%= env.id %>">å¯åŠ¨</button>
                  <% } else { %>
                    <button class="btn-stop" data-id="<%= env.id %>">åœæ­¢</button>
                    <!-- æ·»åŠ å…ƒç´ æ¢ç´¢å™¨æŒ‰é’® -->
                    <a href="/element-explorer/<%= env.id %>" class="btn-explore">æ¢ç´¢å…ƒç´ </a>
                  <% } %>
                </div>
              </div>
            <% }); %>
          <% } %>
        </div>
        <button id="btn-refresh-envs" class="btn-refresh">åˆ·æ–°çŠ¶æ€</button>
      </div>
      
      <!-- å³ä¾§å†…å®¹åŒº -->
      <div class="content-panel">
        <!-- æ—¥å¿—åŒºåŸŸ -->
        <div class="log-panel">
          <h2>æ“ä½œæ—¥å¿—</h2>
          <div id="log-content" class="log-content"></div>
          <button id="btn-clear-log" class="btn-clear">æ¸…ç©ºæ—¥å¿—</button>
        </div>
        
        <!-- å‘½ä»¤åŒºåŸŸ -->
        <div class="command-panel">
          <h2>å‘½ä»¤æ§åˆ¶</h2>
          
          <div class="selected-env-info">
            <span>å½“å‰é€‰æ‹©: </span>
            <span id="selected-env-id">æœªé€‰æ‹©</span>
          </div>
          
          <!-- ç¯å¢ƒå¤‡æ³¨ -->
          <div class="env-note-section">
            <h3>ç¯å¢ƒå¤‡æ³¨</h3>
            <input type="text" id="env-note-input" placeholder="æ·»åŠ å¤‡æ³¨ä»¥ä¾¿è¯†åˆ«ç¯å¢ƒ..." maxlength="30">
            <button id="btn-save-note" disabled>ä¿å­˜å¤‡æ³¨</button>
          </div>
          
          <!-- ä»»åŠ¡æ¨¡æ¿é€‰æ‹© -->
          <div class="task-selection">
            <h3>é¢„è®¾ä»»åŠ¡</h3>
            <select id="task-select">
              <option value="">-- é€‰æ‹©ä»»åŠ¡ --</option>
              <% if (Array.isArray(tasks) && tasks.length > 0) { %>
                <% tasks.forEach(function(task) { %>
                  <option value="<%= task.id %>"><%= task.name %></option>
                <% }); %>
              <% } %>
            </select>
            <button id="btn-run-task" disabled>æ‰§è¡Œä»»åŠ¡</button>
          </div>
          
          <!-- è‡ªå®šä¹‰å‘½ä»¤ -->
          <div class="custom-command">
            <h3>è‡ªå®šä¹‰å‘½ä»¤</h3>
            <textarea id="command-input" placeholder="è¾“å…¥JavaScriptä»£ç ..."></textarea>
            <button id="btn-execute-command" disabled>æ‰§è¡Œå‘½ä»¤</button>
          </div>
          
          <!-- AIå‘½ä»¤ -->
          <div class="ai-command">
            <h3>AIåŠ©æ‰‹å‘½ä»¤</h3>
            <p class="command-help">ç›´æ¥ç”¨è‡ªç„¶è¯­è¨€æè¿°æ‚¨æƒ³æ‰§è¡Œçš„æ“ä½œï¼Œå¦‚"ç™»å½•ç½‘ç«™ï¼Œç”¨æˆ·åä¸ºadmin"</p>
            <textarea id="ai-command-input" placeholder="è¾“å…¥æ‚¨æƒ³æ‰§è¡Œçš„æ“ä½œ..."></textarea>
            <button id="btn-execute-ai-command" disabled <%= !openaiEnabled ? 'title="OpenAI APIå¯†é’¥æœªé…ç½®"' : '' %>>
              æ‰§è¡ŒAIå‘½ä»¤ <%= !openaiEnabled ? '(æœªå¯ç”¨)' : '' %>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // æ·»åŠ å…ƒç´ æ¢ç´¢å™¨å¯¼èˆªå¤„ç†
    document.addEventListener('DOMContentLoaded', function() {
      const navExplorer = document.getElementById('nav-element-explorer');
      if (navExplorer) {
        navExplorer.addEventListener('click', function(event) {
          event.preventDefault();
          
          // è·å–å½“å‰é€‰ä¸­çš„ç¯å¢ƒ
          const selectedEnvElement = document.querySelector('.env-item.active');
          if (!selectedEnvElement) {
            alert('è¯·å…ˆé€‰æ‹©å¹¶å¯åŠ¨ä¸€ä¸ªç¯å¢ƒ');
            return;
          }
          
          const envId = selectedEnvElement.getAttribute('data-id');
          if (envId) {
            window.location.href = `/element-explorer/${envId}`;
          } else {
            alert('æ— æ³•ç¡®å®šç¯å¢ƒID');
          }
        });
      }
    });
  </script>
  
  <% if (typeof scripts !== 'undefined' && Array.isArray(scripts)) { %>
    <% scripts.forEach(function(script) { %>
      <script src="<%= script %>"></script>
    <% }); %>
  <% } else { %>
    <script src="/js/main.js"></script>
  <% } %>
</body>
</html>

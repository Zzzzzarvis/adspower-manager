// 元素探索器页面路由
app.get('/element-explorer/:envId', async (req, res) => {
  const envId = req.params.envId;
  
  if (!environments[envId] || !environments[envId].controller) {
    return res.status(404).send(`环境 ${envId} 未运行，无法打开元素探索器`);
  }
  
  res.render('element-explorer', { envId });
});

// 获取页面截图
app.get('/api/element-explorer/screenshot/:envId', async (req, res) => {
  const envId = req.params.envId;
  
  try {
    if (!environments[envId] || !environments[envId].controller) {
      return res.status(404).json({ success: false, message: '环境未运行' });
    }
    
    const controller = environments[envId].controller;
    
    // 添加错误处理和超时控制
    try {
      console.log("开始获取截图...");
      const screenshot = await controller.page.screenshot({ encoding: 'base64' });
      console.log("截图获取成功");
      
      res.json({ 
        success: true, 
        data: {
          screenshot: `data:image/png;base64,${screenshot}`,
          url: await controller.page.url()
        }
      });
    } catch (screenshotError) {
      console.error("截图失败:", screenshotError);
      // 返回一个占位图像
      res.json({
        success: true,
        data: {
          screenshot: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8z8BQDwAEhQGAhKmMIQAAAABJRU5ErkJggg==',
          url: '无法获取页面截图'
        }
      });
    }
  } catch (error) {
    console.error(`获取截图失败:`, error);
    res.status(500).json({ success: false, message: `获取截图失败: ${error.message}` });
  }
});

// 获取页面元素
app.get('/api/element-explorer/elements/:envId', async (req, res) => {
  const envId = req.params.envId;
  const { query } = req.query;
  
  try {
    if (!environments[envId] || !environments[envId].controller) {
      return res.status(404).json({ success: false, message: '环境未运行' });
    }
    
    const controller = environments[envId].controller;
    
    // 添加超时和错误处理
    try {
      console.log("开始获取页面元素...");
      // 简化版获取元素
      const elements = await controller.page.evaluate((searchQuery) => {
        // 简化元素获取逻辑
        const visibleElements = Array.from(document.querySelectorAll('*'))
          .filter(el => {
            const rect = el.getBoundingClientRect();
            const styles = window.getComputedStyle(el);
            return rect.width > 0 && rect.height > 0 && 
                   styles.display !== 'none' && 
                   styles.visibility !== 'hidden';
          })
          .slice(0, 100)  // 限制数量
          .map((el, i) => {
            const rect = el.getBoundingClientRect();
            return {
              index: i,
              tag: el.tagName.toLowerCase(),
              id: el.id || '',
              classes: Array.from(el.classList).join(' '),
              text: (el.textContent || '').trim().substring(0, 50),
              rect: {
                x: rect.x,
                y: rect.y,
                width: rect.width,
                height: rect.height
              },
              selector: el.id ? `#${el.id}` : el.tagName.toLowerCase(),
              xpath: '/' + el.tagName.toLowerCase()
            };
          });
          
        // 如果有搜索查询，过滤元素
        if (searchQuery) {
          const query = searchQuery.toLowerCase();
          return visibleElements.filter(el => 
            el.text.toLowerCase().includes(query) || 
            el.id.toLowerCase().includes(query) || 
            el.classes.toLowerCase().includes(query) || 
            el.tag.includes(query)
          );
        }
        
        return visibleElements;
      }, query);
      
      console.log("元素获取成功，数量:", elements.length);
      res.json({ success: true, data: elements });
    } catch (elementsError) {
      console.error("获取元素失败:", elementsError);
      res.json({ success: true, data: [] }); // 返回空数组
    }
  } catch (error) {
    console.error(`获取页面元素失败:`, error);
    res.status(500).json({ success: false, message: `获取页面元素失败: ${error.message}` });
  }
});

// 点击页面元素
app.post('/api/element-explorer/click/:envId', async (req, res) => {
  const envId = req.params.envId;
  const { selector } = req.body;
  
  try {
    if (!environments[envId] || !environments[envId].controller) {
      return res.status(404).json({ success: false, message: '环境未运行' });
    }
    
    if (!selector) {
      return res.status(400).json({ success: false, message: '缺少元素选择器' });
    }
    
    const controller = environments[envId].controller;
    
    // 尝试点击元素
    try {
      console.log(`尝试点击元素: ${selector}`);
      await controller.page.waitForSelector(selector, { timeout: 5000 });
      await controller.page.click(selector);
      console.log("元素点击成功");
      
      // 记录点击
      if (stateManagers[envId]) {
        stateManagers[envId].recordClick(selector);
      }
      
      res.json({ success: true, message: '元素点击成功' });
    } catch (clickError) {
      console.error("点击元素失败:", clickError);
      res.status(500).json({ success: false, message: `点击元素失败: ${clickError.message}` });
    }
  } catch (error) {
    console.error(`点击元素失败:`, error);
    res.status(500).json({ success: false, message: `点击元素失败: ${error.message}` });
  }
});

// 输入文本
app.post('/api/element-explorer/type-text/:envId', async (req, res) => {
  const envId = req.params.envId;
  const { selector, text } = req.body;
  
  try {
    if (!environments[envId] || !environments[envId].controller) {
      return res.status(404).json({ success: false, message: '环境未运行' });
    }
    
    if (!selector || text === undefined) {
      return res.status(400).json({ success: false, message: '缺少元素选择器或文本' });
    }
    
    const controller = environments[envId].controller;
    
    // 尝试输入文本
    try {
      console.log(`尝试在元素 ${selector} 中输入文本`);
      await controller.page.waitForSelector(selector, { timeout: 5000 });
      await controller.page.type(selector, text);
      console.log("文本输入成功");
      
      res.json({ success: true, message: '文本输入成功' });
    } catch (typeError) {
      console.error("输入文本失败:", typeError);
      res.status(500).json({ success: false, message: `输入文本失败: ${typeError.message}` });
    }
  } catch (error) {
    console.error(`输入文本失败:`, error);
    res.status(500).json({ success: false, message: `输入文本失败: ${error.message}` });
  }
});

// 测试路由
app.get('/api/element-explorer/test', (req, res) => {
  res.json({ success: true, message: '元素探索器API正常工作' });
});
